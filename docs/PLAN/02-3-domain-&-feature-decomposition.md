# 3. Domain & Feature Decomposition

## 3.1 DailyCard

### User Stories

**50대:**
- "매일 아침 출근 전 3분, 오늘의 AI 트렌드 카드를 읽고 퀴즈를 풀며 포인트를 모아요."
- "카드에서 '챗GPT로 이메일 작성하기' 팁을 보고 바로 회사에서 써봤어요."

**60대:**
- "카드가 너무 길면 글씨가 작아 보이는데, 큰 글씨 모드로 읽고 TTS로 들으니 편해요."
- "사기 예방 카드를 읽고 어제 받은 문자가 스미싱이었다는 걸 알았어요."

**70대:**
- "손주가 '오늘의 카드 완료하셨어요?' 물어보는데, 큰 버튼 하나만 누르면 끝나서 좋아요."
- "퀴즈는 어렵지만 틀려도 설명이 나와서 다시 배워요."

### Primary Entities

- **cards**: 카드 메타데이터 (id, type, title, tldr, body, impact, quiz_json, user_id, date, status, completed_at)
- **gamification**: 포인트, 스트릭 업데이트
- **reactions**: 사용자 반응 (cheer, useful)

### Invariants

- 한 사용자는 특정 날짜에 **최대 1개의 활성 카드**만 가질 수 있음
- 카드 완료는 **멱등성**: 같은 카드를 여러 번 완료해도 포인트는 1회만 부여
- 퀴즈 정답률은 **0-100%** 범위, 음수 불가
- 카드 상태: `pending` → `active` → `completed` (역행 불가)

### Failure Modes

- **카드 불러오기 실패** (네트워크/DB):
  - "지금은 네트워크가 불안정해요. 잠시 후 다시 시도해 주세요."
  - 로컬 캐시에서 어제 카드 표시 (선택적)
  
- **TTS 재생 실패** (권한/OS):
  - "음성 읽기 기능을 사용할 수 없어요. 설정에서 권한을 확인해 주세요."
  - 텍스트만 표시, 계속 이용 가능
  
- **퀴즈 제출 실패** (타임아웃):
  - "답안이 저장되지 않았어요. 다시 제출할까요?"
  - 로컬 저장 → 재시도 버튼

## 3.2 InsightHub

### User Stories

**50대:**
- "AI 토픽을 팔로우하면 관련 인사이트가 매주 정리되어 푸시로 와요."
- "빅테크 기업 뉴스를 읽고 '도움됐어요' 버튼을 눌렀어요."

**60대:**
- "안전 토픽의 최근 10개 글을 한 번에 보고, TTS로 하나씩 들어요."
- "월간 요약 페이지에서 이번 달 주요 트렌드를 복습해요."

**70대:**
- "인사이트는 카드보다 길어서 가족이 같이 읽어줘요."
- "저장 기능으로 나중에 다시 보려고 했는데, 어디 갔는지 잊어버렸어요."

### Primary Entities

- **insights**: 인사이트 콘텐츠 (id, topic, title, body, published_at, is_published)
- **insight_follows**: 사용자-토픽 팔로우 관계
- **reactions**: 인사이트 반응 (useful, cheer)

### Invariants

- 토픽은 **사전 정의된 5종**만 허용: `ai`, `bigtech`, `economy`, `safety`, `mobile101`
- 인사이트는 **published_at 이후**에만 사용자에게 노출
- 팔로우/언팔로우는 **멱등성**: 중복 팔로우 허용 안 함
- 반응은 사용자당 인사이트당 **1개 타입만** (useful 또는 cheer, 동시 불가)

### Failure Modes

- **토픽 리스트 불러오기 실패**:
  - "인사이트를 불러올 수 없어요. 잠시 후 다시 시도해 주세요."
  - 캐시된 목록 표시 (있다면)
  
- **팔로우 실패** (네트워크):
  - "팔로우 설정이 저장되지 않았어요. 다시 시도해 주세요."
  - 로컬 상태 롤백
  
- **푸시 알림 미전송** (권한/설정):
  - "알림 권한이 없어요. 설정에서 알림을 허용해 주세요."
  - 앱 내 알림 배지로 대체

## 3.3 VoiceIntent

### User Stories

**50대:**
- "'네이버 열어 줘'라고 말하면 바로 네이버 앱이 실행돼요."
- "'내일 오후 2시 미팅 알림 설정해 줘'로 캘린더 알림 생성."

**60대:**
- "'딸에게 문자 보내 줘'라고 하면 문자 앱이 열리고 딸 연락처가 자동 입력돼요."
- "음성 인식이 잘못될 때가 있는데, 다시 말하기 버튼이 있어서 괜찮아요."

**70대:**
- "버튼을 누르고 '집 근처 병원 찾아 줘'라고 말하면 지도가 열려요."
- "소음이 많으면 인식이 안 돼서, 조용한 곳에서만 써요."

### Primary Entities

- **voice_intents**: 파싱된 인텐트 로그 (id, user_id, raw_text, intent, slots_json, action_json, created_at)
- **contacts**: 사용자 연락처 (name, phone, relation) - 선택적 저장
- **gamification**: 음성 사용 포인트

### Invariants

- 인텐트 타입은 **6종 고정**: `open`, `search`, `call`, `sms`, `remind`, `navigate`
- `call`, `sms` 인텐트는 **사용자 명시적 승인** 후에만 실행
- 파싱 실패 시 `intent: 'unknown'`, `confidence: 0`으로 기록
- 민감 인텐트(call/sms)는 **audit_logs 필수 기록**

### Failure Modes

- **음성 인식 실패** (권한/소음):
  - "음성을 인식할 수 없어요. 다시 말씀해 주세요."
  - 마이크 권한 확인 프롬프트
  
- **인텐트 파싱 실패** (모호한 문장):
  - "무엇을 도와드릴까요? 예: '엄마에게 전화해 줘', '지하철역 찾아 줘'"
  - 예시 문장 3개 표시
  
- **연락처 없음** (call/sms):
  - "'엄마' 연락처를 찾을 수 없어요. 연락처를 추가해 주세요."
  - 연락처 앱으로 이동 버튼

## 3.4 ScamCheck

### User Stories

**50대:**
- "회사에서 받은 의심스러운 이메일을 복사해서 사기검사에 넣어봤어요."
- "URL 단축 링크를 붙여넣었더니 '위험' 판정이 나왔어요."

**60대:**
- "국세청 사칭 문자를 검사했더니 '매우 위험' 경고와 함께 '절대 클릭하지 마세요' 팁이 나왔어요."
- "안전 판정 받은 메시지도 혹시 몰라 가족에게 한 번 더 물어봐요."

**70대:**
- "문자 전체를 복사하는 게 어려워서 가족이 대신 검사해 줘요."
- "빨간색 경고 화면이 나오면 무서워서 바로 삭제해요."

### Primary Entities

- **scam_checks**: 검사 로그 (id, user_id, input_text, input_url, label, confidence, explanation, created_at)
- **scam_rules**: 룰 정의 (키워드, 도메인 블랙리스트) - 서버 측 설정
- **usage_counters**: 사용 횟수 집계

### Invariants

- 판정 라벨은 **3종 고정**: `safe`, `warn`, `danger`
- Confidence는 **0.0-1.0** 범위
- 레이트 리미팅: **1분당 5회** (Redis)
- 입력 텍스트는 **최대 2000자**, URL은 **최대 500자**
- 민감 정보(계좌번호, 주민번호)는 **마스킹 후 로그**

### Failure Modes

- **레이트 리미팅 초과**:
  - "잠시 후 다시 시도해 주세요. (1분에 5회 제한)"
  - 남은 시간 카운트다운 표시
  
- **입력 길이 초과**:
  - "텍스트가 너무 길어요. 2000자 이내로 줄여주세요."
  - 현재 글자 수 표시
  
- **판정 실패** (룰 엔진 오류):
  - "지금은 사기검사를 할 수 없어요. 의심스러운 내용은 가족이나 경찰(112)에 문의하세요."
  - 항상 안전 우선 메시지

## 3.5 ToolTrack

### User Stories

**50대:**
- "미리캔버스 트랙을 따라 4단계를 완료하고 '디자인 입문자' 배지를 받았어요."
- "각 단계마다 체크리스트가 있어서 빠뜨리지 않고 따라할 수 있어요."

**60대:**
- "소라(AI 영상)트랙을 시작했는데 2단계에서 막혀서 1단계를 다시 복습했어요."
- "퀴즈를 틀려도 설명이 나와서 이해가 돼요."

**70대:**
- "가족이 '캔바 트랙 해봐요'라고 했는데, 1단계부터 어려워서 포기했어요."
- "큰 그림과 한 줄 설명만 있으면 좋겠어요."

### Primary Entities

- **tool_tracks**: 트랙 메타데이터 (id, tool_name, title, description, steps_json, difficulty)
- **tools_progress**: 사용자 진행도 (user_id, track_id, step_num, completed_at, unlocked_steps)
- **gamification**: 단계 완료 포인트, 트랙 완주 배지

### Invariants

- 트랙은 **순차 진행**: 이전 단계 완료 없이 다음 단계 불가 (unlock 방식)
- 각 단계는 **재완료 허용** (재학습 목적)
- 진행률은 **0-100%**, 소수점 1자리
- 트랙 난이도: `beginner`, `intermediate`, `advanced` 중 하나

### Failure Modes

- **단계 불러오기 실패**:
  - "트랙 정보를 불러올 수 없어요. 잠시 후 다시 시도해 주세요."
  - 이전 단계 정보 표시 (캐시)
  
- **순서 위반 시도**:
  - "이전 단계를 먼저 완료해 주세요."
  - 현재 완료된 단계 강조
  
- **완료 저장 실패**:
  - "진행 상황이 저장되지 않았어요. 다시 시도해 주세요."
  - 로컬 임시 저장 → 재시도

## 3.6 LightCommunity

### User Stories

**50대:**
- "Q&A에서 '갤럭시 사진 백업 방법' 질문을 올렸더니 다른 분이 '도움됐어요' 눌러줬어요."
- "익명으로 질문할 수 있어서 부끄러운 질문도 할 수 있어요."

**60대:**
- "사기 관련 질문을 검색하니 비슷한 사례가 많이 나와서 안심했어요."
- "댓글 기능이 없어서 간단하고 좋아요."

**70대:**
- "질문하기 버튼을 눌렀는데 제목과 본문을 다 써야 해서 어려웠어요."
- "다른 사람 질문을 읽기만 해요."

### Primary Entities

- **qna_posts**: 질문 게시글 (id, author_id, subject, title, body, is_anon, ai_summary, created_at, is_deleted)
- **qna_votes**: 투표 (post_id, user_id, vote_type: 'useful')
- **reactions**: 게시글 반응 (cheer, useful)
- **moderation_logs**: 신고/금칙어 필터 로그

### Invariants

- 게시글은 **작성자만 삭제 가능** (is_deleted = true, 실제 DELETE 안 함)
- 익명 게시글도 **author_id는 저장** (관리/신고 목적)
- 제목 **최대 100자**, 본문 **최대 1000자**
- 주제(subject)는 **4종 프리셋**: `폰`, `사기`, `도구`, `생활`
- 투표는 사용자당 게시글당 **1회만**

### Failure Modes

- **금칙어 감지**:
  - "부적절한 단어가 포함되어 있어요. 수정 후 다시 작성해 주세요."
  - 해당 단어 하이라이트 (선택적)
  
- **길이 초과**:
  - "제목은 100자, 본문은 1000자 이내로 작성해 주세요."
  - 현재 글자 수 표시
  
- **중복 투표 시도**:
  - "이미 투표하셨어요."
  - 조용히 무시 (에러 표시 안 함)

## 3.7 FamilyMed

### User Stories

**50대 (시니어):**
- "아침 약 먹고 큰 버튼 누르면 가족에게 알림이 가요."
- "3일 연속 체크하면 포인트가 더 많이 올라요."

**60대 (시니어):**
- "약 먹는 걸 자주 잊는데, 앱에서 알림이 와서 도움이 돼요."
- "가족이 '어제 약 드셨어요?' 물어보지 않아도 앱에서 확인하는 것 같아요."

**70대 (시니어):**
- "버튼 하나만 누르면 끝이라 쉬워요."
- "가끔 실수로 두 번 눌렀는데 괜찮대요."

**가족 (Web):**
- "어머니가 이번 주 5일 약을 챙기셨어요. 걱정 덜었어요."
- "복약 연속 기록이 끊기면 부드럽게 확인 전화를 드려요."

### Primary Entities

- **med_checks**: 복약 체크 기록 (user_id, date, time_slot: 'morning'/'lunch'/'evening', checked_at)
- **family_links**: 가족 연결 (senior_id, guardian_id, relation, status, created_at)
- **alerts**: 가족 알림 (guardian_id, type, payload, is_read)
- **gamification**: 복약 포인트, 연속 스트릭

### Invariants

- 하루 최대 **3회 체크** (아침/점심/저녁)
- 같은 시간대 **중복 체크 불가**
- 가족 링크는 **양방향 동의** 필요 (초대 → 수락)
- guardian는 **최대 5명의 시니어** 관리 가능
- 시니어는 **최대 3명의 guardian** 연결 가능

### Failure Modes

- **중복 체크 시도**:
  - "오늘 아침 약은 이미 체크하셨어요!"
  - 체크 시간 표시
  
- **가족 링크 미연결**:
  - "가족 연결이 없어요. 설정에서 가족을 초대해 보세요."
  - 초대 화면으로 이동 버튼
  
- **대시보드 권한 없음** (Web):
  - "이 사용자의 정보를 볼 권한이 없습니다."
  - 403 Forbidden

## 3.8 Gamification

### User Stories

**50대:**
- "카드 완료하면 10포인트, 퀴즈 맞히면 5포인트 추가로 받아요."
- "100포인트 모으면 '열정 학습자' 배지를 받았어요."

**60대:**
- "7일 연속 카드 완료하면 '꾸준한 학습자' 배지를 받아요."
- "포인트가 쌓이는 게 재미있어서 매일 접속해요."

**70대:**
- "포인트가 뭔지 잘 모르지만, 숫자가 올라가는 게 보여요."
- "배지는 가족이 '대단하다'고 칭찬해 줘요."

### Primary Entities

- **gamification**: 포인트, 레벨, 스트릭, 배지 목록 (user_id, points, level, current_streak, badges_json)
- **badge_definitions**: 배지 정의 (id, name, description, condition, icon_url)
- **point_transactions**: 포인트 지급/차감 로그 (user_id, amount, reason, created_at)

### Invariants

- 포인트는 **항상 0 이상** (음수 불가)
- 레벨은 **포인트 기반 자동 산출** (100pts = Lv1, 500pts = Lv2, ...)
- 스트릭은 **연속일수**, 하루 누락 시 **0으로 리셋**
- 배지는 **중복 획득 불가** (이미 보유 시 재지급 안 함)
- 모든 포인트 변경은 **point_transactions 로그 필수**

### Failure Modes

- **포인트 지급 실패** (DB 충돌):
  - "포인트 지급이 지연되고 있어요. 잠시 후 확인해 주세요."
  - 비동기 재시도 큐 등록
  
- **배지 조건 오류**:
  - 조용히 실패, 관리자 알림
  - 사용자에게는 에러 노출 안 함
  
- **레벨 계산 오류**:
  - 포인트는 정상 표시, 레벨만 "계산 중..."
  - 백그라운드 재계산

## 3.9 Accessibility

### User Stories

**50대:**
- "기본 모드(normal)로 충분해요. 글씨 크기와 버튼이 적당해요."
- "밤에는 다크 모드로 바꿔서 눈이 편해요."

**60대:**
- "쉬운 모드(easy)로 설정하면 글씨가 커지고 버튼 간격이 넓어져서 좋아요."
- "TTS로 카드를 들으면서 산책해요."

**70대:**
- "초간단 모드(ultra)는 버튼이 정말 커서 실수 안 해요."
- "색 대비가 강해서 글씨가 잘 보여요."

### Primary Entities

- **profiles.a11y_mode**: 접근성 모드 (`normal`, `easy`, `ultra`)
- **profiles.preferences_json**: 폰트 크기, 대비, TTS 속도 등 상세 설정
- **tts_logs**: TTS 사용 로그 (선택적)

### Invariants

- 모드 변경은 **즉시 반영** (재시작 불필요)
- 모든 모드에서 **WCAG 2.1 AA 이상** 목표
- 터치 영역: normal=44x44dp, easy=60x60dp, ultra=80x80dp
- 폰트 크기: normal=16sp, easy=20sp, ultra=28sp
- TTS 지원은 **모든 주요 텍스트** (카드, 인사이트, 에러 메시지)

### Failure Modes

- **TTS 초기화 실패**:
  - "음성 읽기 기능을 사용할 수 없어요."
  - 텍스트만 표시, 앱 사용 계속 가능
  
- **모드 변경 실패**:
  - "설정을 저장할 수 없어요. 다시 시도해 주세요."
  - 이전 설정 유지
  
- **대비 조정 불가** (디바이스 제약):
  - "일부 색상 설정이 지원되지 않을 수 있어요."
  - 최선의 폴백 적용

---
