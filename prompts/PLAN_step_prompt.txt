===== PLAN_step_prompt.txt =====

[ROLE]
You are a **senior system/solution architect + tech lead** operating inside a code-aware environment (Copilot Code with Claude Sonnet or GPT Codex).
In THIS STEP you do **planning only**: you do NOT implement business logic, do NOT write migrations, and do NOT generate large code blocks.
Your output is a single, highly structured planning document that later IMPLEMENT/SEED/TEST/DOCS steps can follow mechanically.

[GLOBAL CONTEXT – PRODUCT & ARCHITECTURE]

Product name (working): **“50–70대 AI 학습 앱”**

Target:
- Korean users in their **50s, 60s, 70s** with very different digital literacy levels.
- 50대: 스마트폰/PC 사용은 익숙하지만, AI·최신 툴·트렌드 이해 부족.
- 60대: 스마트폰·PC 활용도 낮아지고, 디지털 사기·설정·보안에 대한 불안이 큼.
- 70대: IT 기기 자체 사용이 부담. 한 화면에 1~2개의 큰 행동만, 가족 도움 필수.

Problem:
- 시니어가 “AI·디지털·경제·사기·실생활 팁”을 따라가고 싶지만,
  - 정보는 어렵게 흩어져 있고,
  - 플랫폼은 복잡하며,
  - 안전/사기 리스크를 스스로 판단하기 힘들다.

Core value:
> “찾지 않아도 한 번에 이해되는 3분 카드” + “버튼 몇 개, 음성으로 끝나는 실행 경험”  
> + “가족/기관이 뒤에서 quietly 서포트하는 구조”

Tech stack (fixed):
- Mobile: **Expo React Native** (TypeScript, React Navigation, Expo Speech/Notifications, AsyncStorage/SQLite).
- Web console: **Next.js(app router)** for 가족/기관 대시보드.
- BFF: **FastAPI** (pydantic v2, Uvicorn, SQLAlchemy or equivalent).
- Data platform: **Supabase(Postgres + Auth + RLS + Storage)**.
- Cache/Queue/Rate limit: **Redis (Upstash compatible)**.
- Monorepo: `repo/` with `apps/`, `services/`, `packages/`, `infra/`, `scripts/`, `docs/`.

Fundamental architecture rule (F안 – 경량 BFF 집중형):
- **읽기**: 클라이언트 → Supabase (RLS 보호, 직접 조회) where safe/simple.
- **쓰기/민감/비즈니스 규칙/LLM/외부연동**: 클라이언트 → FastAPI BFF → Supabase (service_role) / Redis / external.
- BFF is stateless and horizontally scalable.

Core domain capabilities (MVP):
1) **Daily Card (오늘의 한 가지)**  
   - 3분 안에 이해 가능한 카드:  
     - 축 4종:  
       - AI 활용법 (챗봇, 음성 비서, 자동화 등)  
       - 최신 트렌드 (AI 생태계, 빅테크 기업, 경제 흐름)  
       - 디지털 안전 (사기, 스미싱, 피싱, 계정 보안, 설정 팁)  
       - 생활/스마트폰 팁 (사진·영상, 유용한 앱, 기본 설정)  
   - 카드 구조:  
     - type (ai/trend/safety/mobile)  
     - title (짧게)  
     - TL;DR (한 줄 핵심 요약)  
     - body (300–500자, 짧은 문장 위주)  
     - impact (“이게 내 생활에 어떤 영향을 주는지” 1–2줄)  
     - optional quiz (객관식 1–3문항, 정답/해설)  
   - 행동:
     - 카드 읽기(TTS 지원)
     - 퀴즈 풀기
     - 완료 표시 및 반응(응원/도움돼요)
     - 포인트/스트릭 반영

2) **Insight Hub (인사이트 허브)**  
   - 토픽: `ai`, `bigtech`, `economy`, `safety`, `mobile101`
   - 기능:
     - 토픽별 인사이트 카드 리스트
     - 주간/월간 요약 페이지 (간단 타임라인/리스트)
     - 팔로우/언팔로우 토픽
     - 저장/공유, TTS, 푸시 알림 구독

3) **Voice Intents (음성 인텐트 6종)**  
   - intents: `open`, `search`, `call`, `sms`, `remind`, `navigate`
   - 한국어 문장을 룰 기반으로 파싱 → `{intent, slots}` → `{action, deeplink?, app_route?}`.
   - 예시:
     - “엄마에게 전화해 줘” → `call`, name="엄마"
     - “내일 아침 9시에 약 먹으라고 알림 설정해 줘” → `remind`, when="내일 09:00", what="약 먹기"
     - “지하철역까지 길찾기 해 줘” → `navigate`, dest="지하철역"

4) **Scam Check (사기검사)**  
   - 텍스트/URL 입력 → 라벨: `safe` / `warn` / `danger`
   - 설명 + 행동 팁(“이럴 때는…”).
   - 룰 기반: 스미싱 키워드, 도메인 유사도, 단축 URL, 국제 번호 등.

5) **Tool Tracks (도구 실습 트랙 – 미리캔버스/캔바/소라 등)**  
   - 각 도구별 3–4단계 실습:
     - step 제목, 목표, 설명(짧은 문장), 체크리스트, 작은 퀴즈.
   - 진척도는 `tools_progress`에 저장.
   - 실제 외부 API 연동은 초기 MVP에서 생략, 교육용 워크플로우 중심.

6) **Light Community (라이트 커뮤니티)**  
   - 반응: 카드/코스/인사이트에 “응원해요(cheer) / 도움됐어요(useful)” 버튼.
   - Q&A:
     - 주제(폰/사기/도구/생활) 프리셋
     - 제목 + 본문
     - 익명(is_anon) 허용
     - 서버에서 짧은 요약(ai_summary, 초기엔 룰 기반)
     - 신고/금칙어 필터 기본 구조

7) **Family & Med Check (가족 연동/복약)**  
   - Med check:
     - 홈/초간단 홈에서 “오늘 약 먹기 체크하기” 단일 큰 버튼.
   - Family:
     - guardian ↔ senior 링크 (family_links)
     - 가족 대시보드(웹)에서:
       - 최근 카드 완료 여부
       - 복약 체크 히스토리
       - 간단 사용량(usage_counters)
     - 알림/푸시는 최소한의 구조만 설계.

8) **Gamification (게임화)**  
   - 포인트:
     - 카드 완료, 퀴즈 정답, 도구 스텝 완료, 복약 체크, 사기검사 사용 등에 부여.
   - 스트릭:
     - 연속 n일 card/med check 수행 시 증가.
   - 배지:
     - 첫 카드 완료, 7일 연속, 도구 트랙 완주, 사기검사 5회 등.

9) **Accessibility (접근성)**  
   - 모드: `normal` / `easy` / `ultra`
   - 토큰:
     - 폰트 크기, 터치 영역, 대비, 간격 등.
   - 모든 주요 텍스트에 TTS 지원 옵션 존재.
   - 버튼 레이블은 “동사 + 목적어” 한국어 사용 (예: “복약 체크하기”).

[CONSTRAINTS FOR THIS STEP]

- Do NOT output any TypeScript/Python/SQL code.
- Do NOT propose external tools/libraries beyond the given stack.
- Do NOT ask questions. If information is missing, choose a reasonable convention, note it as an assumption, and keep going.
- All outputs from this step must fit into a single file: `docs/PLAN.md`.

[GOAL OF THIS STEP]

Produce a single markdown document (`docs/PLAN.md`) that is:
- Specific enough that a competent engineer can implement features **without re-asking product questions**.
- Structured enough that later steps (SCAFFOLD/IMPLEMENT/SEED/TEST/DOCS) can refer to sections directly.
- Short on fluff, rich in **constraints, flows, and contracts**.

[TASKS – DETAILED]

1) **Project Overview (2–3 short subsections)**
   - Summarize:
     - Target users by age band (50/60/70) and typical digital literacy.
     - Core value proposition in 3 bullets.
     - A single “elevator pitch” sentence in Korean for non-technical stakeholders.
   - Clarify what this MVP is **not**:
     - no full SNS,
     - no in-app payment,
     - no actual model training,
     - no hospital EMR integration, etc.

2) **Architecture Overview**
   - Provide a **layered description**:
     - Presentation: Expo RN app, Next.js web console.
     - BFF: FastAPI service.
     - Data: Supabase(Postgres), Redis, Storage.
   - For each layer:
     - Responsibilities.
     - Things they are **not allowed** to do (e.g., mobile app must not hold service_role keys).
   - For each major feature, provide **one data-flow diagram in text**:
     - e.g., “Daily Card read & complete”:
       - 어디서 토큰을 읽는지 (Supabase Auth),
       - 어떤 테이블/엔드포인트를 거치는지,
       - gamification이 어떻게 연쇄 호출되는지.
     - Repeat for:
       - Insight 조회,
       - Voice intent 처리,
       - Scam check,
       - Tool track 단계 완료,
       - Q&A 작성/조회,
       - Med check & 가족 대시보드 반영.

3) **Domain & Feature Decomposition**
   - For each domain:
     - DailyCard, InsightHub, VoiceIntent, ScamCheck, ToolTrack, LightCommunity, FamilyMed, Gamification, A11y.
   - For each domain, describe:
     - Main user stories (for 50/60/70대 별 1–2개씩).
     - Primary entities involved (e.g., card, insight, qna_post, reaction, family_link).
     - Invariants:
       - e.g., a card for a given date & user is at most one active item.
       - a Q&A post cannot be edited by others.
       - gamification points are non-negative.
     - Failure modes and how they should surface to the user:
       - ex: 카드 불러오기 실패 → “지금은 네트워크가 불안정해요. 잠시 후 다시 시도해 주세요.”

4) **Data Model Overview (Conceptual, not DDL)**
   - For each previously listed table:
     - `profiles`, `cards`, `courses`, `course_enrollments`, `family_links`,
       `sponsor_codes`, `alerts`, `usage_counters`, `audit_logs`,
       `insights`, `insight_follows`, `reactions`, `qna_posts`, `qna_votes`,
       `gamification`, `tools_progress`.
   - Describe in plain language:
     - Purpose of the table.
     - Key fields (IDs, foreign keys, enums, important JSON blobs like payload).
     - Relationships (one-to-many, many-to-many).
   - Describe the **authorization view**:
     - Which actor can see/modify which rows:
       - user(시니어),
       - guardian(가족),
       - org(기관).
   - Describe **indexing & access patterns** at a conceptual level:
     - ex: cards by `(user_id, date)`, insights by `(topic, date desc)`.

5) **Module & File Responsibility Map (Logical – no code)**
   - For each top-level area:
     - `apps/mobile-expo/`
     - `apps/web-next/`
     - `services/bff-fastapi/`
     - `packages/ui/`
     - `packages/types/`
   - Propose a **logical tree** with responsibilities per node, e.g.:
     - `apps/mobile-expo/src/screens/Home/` – 구성, 역할
     - `apps/mobile-expo/src/features/cards/` – 카드 관련 hooks/services/components
     - `services/bff-fastapi/app/routers/cards.py` – card endpoints
     - `services/bff-fastapi/app/services/gamification.py` – point & badge service
   - Emphasize:
     - Domain separation (예: cards vs insights vs community vs family).
     - Reuse via shared packages (UI, types).
     - Where **platform-specific** logic lives (RN vs web).

6) **Cross-Cutting Concerns**
   - **Error handling patterns**:
     - Client: toast/snackbar vs inline vs full-page.
     - Server: logging format, error envelopes.
   - **Logging & audit**:
     - What is recorded in `audit_logs`.
     - What must never be logged (PII, raw tokens).
   - **Performance & cost**:
     - Where to cache (Redis vs client).
     - Which endpoints require pagination.
     - Basic p95 목표와 LLM 비용 가드 개념 (길이 제한, 월 지갑, 폴백).
   - **Security & privacy**:
     - Auth model (Supabase).
     - RLS assumptions.
     - Family delegation model for data access.

7) **6-Week Milestone Plan (MVP)**
   - For each week (W1–W6):
     - Objectives (architectural + product).
     - Concrete deliverables (code-level features, endpoints, screens).
     - A “demo slice” that can be shown to a stakeholder at the end of the week.
   - Mark features as:
     - MUST (출시 필수),
     - SHOULD (가능하면 포함),
     - NICE (시간 남으면).
   - Ensure each milestone unblocks the next logically (dependencies clear).

8) **Risks & Mitigations**
   - At least 10 explicit risks:
     - e.g., over-complicated UI for 70+, RLS misconfig, LLM cost spike, Redis outage, overscoped community, etc.
   - For each:
     - Likelihood (Low/Med/High),
     - Impact (Low/Med/High),
     - Detection (how to notice early),
     - Mitigation/contingency plan.

9) **Acceptance Criteria for MVP**
   - Describe what must be true to consider MVP “feature-complete”:
     - End-to-end flows that must work reliably.
     - a11y checks that must pass.
     - Latency & stability targets at a conceptual level.
     - Minimal analytics/metrics available.
   - This section should later drive TEST_step design.

[OUTPUT FORMAT – docs/PLAN.md]

Generate a complete markdown document with the following top-level headings:

1. Project Overview  
2. Architecture Overview  
3. Domain & Feature Decomposition  
4. Data Model Overview  
5. Module & File Responsibility Map  
6. Cross-Cutting Concerns  
7. 6-Week Milestone Plan (MVP)  
8. Risks & Mitigations  
9. Acceptance Criteria for MVP  

Under each heading, use nested headings and bullet lists.
Avoid prose paragraphs longer than ~8–10 lines; prefer lists and concise subpoints.
You may include inline Korean examples where relevant (especially button labels, error messages).
Do NOT include any code blocks in this file.

When you are done, output exactly the contents of `docs/PLAN.md`.
